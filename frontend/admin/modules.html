<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Modules - Administrateur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/custom.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">Système Universitaire</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info">Chargement...</span>
                <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded">
                    Déconnexion
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-wrap space-x-1 md:space-x-4">
                <a href="dashboard.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2">Tableau de bord</a>
                <a href="filieres.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2">Filières</a>
                <a href="modules.html" class="bg-blue-100 text-blue-700 px-3 py-2 rounded font-medium mb-2">Modules</a>
                <a href="professors.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2">Professeurs</a>
                <a href="students.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2">Étudiants</a>
                <a href="card-requests.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2">Demandes de cartes</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- En-tête avec filtre et bouton d'ajout -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-3 md:mb-0">Gestion des Modules</h2>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                <div class="relative">
                    <select id="filiere-select" onchange="filterModulesByFiliere()" 
                            class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Toutes les filières</option>
                        <!-- Les options seront remplies dynamiquement -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                        </svg>
                    </div>
                </div>
                <div class="relative">
                    <select id="semestre-select" onchange="filterModulesBySemestre()" 
                            class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Tous les semestres</option>
                        <option value="1">Semestre 1</option>
                        <option value="2">Semestre 2</option>
                        <option value="3">Semestre 3</option>
                        <option value="4">Semestre 4</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                        </svg>
                    </div>
                </div>
                <button onclick="showAddModuleForm()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Ajouter un module
                </button>
            </div>
        </div>
        
        <!-- Formulaire d'ajout/modification (caché par défaut) -->
        <div id="module-form" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
            <h3 id="form-title" class="text-xl font-semibold text-gray-800 mb-4">Ajouter un module</h3>
            <form id="module-form-element" onsubmit="submitModuleForm(event)">
                <input type="hidden" id="module-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="module-nom" class="block text-sm font-medium text-gray-700 mb-1">Nom du module</label>
                        <input type="text" id="module-nom" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="module-filiere" class="block text-sm font-medium text-gray-700 mb-1">Filière</label>
                        <select id="module-filiere" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sélectionner une filière</option>
                            <!-- Les options seront remplies dynamiquement -->
                        </select>
                    </div>
                    <div>
                        <label for="module-semestre" class="block text-sm font-medium text-gray-700 mb-1">Semestre</label>
                        <select id="module-semestre" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sélectionner un semestre</option>
                            <option value="1">Semestre 1</option>
                            <option value="2">Semestre 2</option>
                            <option value="3">Semestre 3</option>
                            <option value="4">Semestre 4</option>
                        </select>
                    </div>
                    <div>
                        <label for="module-professeur" class="block text-sm font-medium text-gray-700 mb-1">Professeur (optionnel)</label>
                        <select id="module-professeur"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sélectionner un professeur</option>
                            <!-- Les options seront remplies dynamiquement -->
                        </select>
                    </div>
                    <div>
                        <label for="module-heures-cours" class="block text-sm font-medium text-gray-700 mb-1">Heures de cours</label>
                        <input type="number" id="module-heures-cours" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="module-heures-td" class="block text-sm font-medium text-gray-700 mb-1">Heures de TD</label>
                        <input type="number" id="module-heures-td" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="module-heures-tp" class="block text-sm font-medium text-gray-700 mb-1">Heures de TP</label>
                        <input type="number" id="module-heures-tp" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="module-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="module-description" rows="3" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModuleForm()" 
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Liste des modules -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filière</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semestre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Professeur</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heures</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="modules-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Chargement des modules...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de confirmation de suppression -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-auto">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Confirmation de suppression</h3>
            <p class="text-gray-600 mb-4">Êtes-vous sûr de vouloir supprimer ce module ? Cette action est irréversible.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteModal()"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded">
                    Annuler
                </button>
                <button id="confirm-delete-btn" 
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de gestion des éléments -->
    <div id="elements-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl mx-auto w-full">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="elements-modal-title">Éléments du module</h3>
                <button onclick="hideElementsModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Formulaire d'ajout d'élément -->
            <div class="mb-6 bg-blue-50 p-4 rounded border border-blue-200">
                <h4 class="font-medium text-blue-800 mb-3">Ajouter un élément</h4>
                <form id="element-form" onsubmit="submitElementForm(event)">
                    <input type="hidden" id="element-module-id">
                    <input type="hidden" id="element-id">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="element-nom" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'élément</label>
                            <input type="text" id="element-nom" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="element-heures-cours" class="block text-sm font-medium text-gray-700 mb-1">Heures de cours</label>
                            <input type="number" id="element-heures-cours" min="0" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="element-heures-td" class="block text-sm font-medium text-gray-700 mb-1">Heures de TD</label>
                            <input type="number" id="element-heures-td" min="0" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="element-heures-tp" class="block text-sm font-medium text-gray-700 mb-1">Heures de TP</label>
                            <input type="number" id="element-heures-tp" min="0" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="element-professeur" class="block text-sm font-medium text-gray-700 mb-1">Professeur (optionnel)</label>
                            <select id="element-professeur"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionner un professeur</option>
                                <!-- Les options seront remplies dynamiquement -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="element-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="element-description" rows="2" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            <span id="element-form-action">Ajouter</span> l'élément
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Liste des éléments -->
            <div id="elements-list" class="max-h-96 overflow-y-auto">
                <div class="animate-pulse bg-gray-200 h-32 rounded"></div>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/common.js"></script>
    <script>
        let currentModuleId = null;
        let allFilieres = [];
        let allProfessors = [];
        let currentFiliereFilter = '';
        let currentSemestreFilter = '';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur est authentifié
            const user = checkAuth();
            if (!user) return;
            
            // Vérifier si l'utilisateur est bien un administrateur
            if (user.role !== 'ADMIN') {
                logout();
                return;
            }
            
            // Afficher les informations de l'utilisateur
            document.getElementById('user-info').textContent = `${user.prenom} ${user.nom}`;
            
            // Charger les filières pour les filtres et formulaires
            loadFilieres();
            
            // Charger les professeurs pour les formulaires
            loadProfessors();
            
            // Charger la liste des modules
            loadModules();
        });
        
        // Charger les filières
        async function loadFilieres() {
            try {
                allFilieres = await apiGet('http://localhost:8080/api/filieres');
                
                // Remplir les sélecteurs de filière
                const filiereSelectFilter = document.getElementById('filiere-select');
                const filiereSelectForm = document.getElementById('module-filiere');
                
                if (allFilieres && allFilieres.length > 0) {
                    const options = allFilieres.map(filiere => `
                        <option value="${filiere.id}">${filiere.nom}</option>
                    `).join('');
                    
                    filiereSelectFilter.innerHTML = `<option value="">Toutes les filières</option>${options}`;
                    filiereSelectForm.innerHTML = `<option value="">Sélectionner une filière</option>${options}`;
                } else {
                    filiereSelectFilter.innerHTML = `<option value="">Aucune filière disponible</option>`;
                    filiereSelectForm.innerHTML = `<option value="">Aucune filière disponible</option>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des filières:', error);
                showNotification('Erreur lors du chargement des filières', 'error');
            }
        }
        
        // Charger les professeurs
        async function loadProfessors() {
            try {
                allProfessors = await apiGet('http://localhost:8080/api/admin/professors');
                
                // Remplir les sélecteurs de professeur
                const professorSelectForm = document.getElementById('module-professeur');
                const elementProfessorSelectForm = document.getElementById('element-professeur');
                
                if (allProfessors && allProfessors.length > 0) {
                    const options = allProfessors.map(professor => `
                        <option value="${professor.id}">${professor.prenom} ${professor.nom}</option>
                    `).join('');
                    
                    professorSelectForm.innerHTML = `<option value="">Sélectionner un professeur</option>${options}`;
                    elementProfessorSelectForm.innerHTML = `<option value="">Sélectionner un professeur</option>${options}`;
                } else {
                    professorSelectForm.innerHTML = `<option value="">Aucun professeur disponible</option>`;
                    elementProfessorSelectForm.innerHTML = `<option value="">Aucun professeur disponible</option>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des professeurs:', error);
                showNotification('Erreur lors du chargement des professeurs', 'error');
            }
        }
        
        // Charger la liste des modules
        async function loadModules() {
            try {
                let url = 'http://localhost:8080/api/modules';
                
                // Appliquer les filtres
                if (currentFiliereFilter || currentSemestreFilter) {
                    // Si les deux filtres sont actifs
                    if (currentFiliereFilter && currentSemestreFilter) {
                        url = `http://localhost:8080/api/filieres/${currentFiliereFilter}/semestres/${currentSemestreFilter}/modules`;
                    }
                    // Si seulement le filtre de filière est actif
                    else if (currentFiliereFilter) {
                        url = `http://localhost:8080/api/filieres/${currentFiliereFilter}/modules`;
                    }
                    // Note: Il n'y a pas d'endpoint pour filtrer uniquement par semestre dans notre API
                }
                
                const modules = await apiGet(url);
                const tbody = document.getElementById('modules-table-body');
                
                // Si un filtre de semestre est actif mais pas de filtre de filière, on doit filtrer manuellement
                let filteredModules = modules;
                if (!currentFiliereFilter && currentSemestreFilter) {
                    filteredModules = modules.filter(module => module.semestre == currentSemestreFilter);
                }
                
                if (filteredModules && filteredModules.length > 0) {
                    tbody.innerHTML = filteredModules.map(module => {
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${module.nom}</div>
                                    <div class="text-xs text-gray-500">${module.description.substring(0, 50)}${module.description.length > 50 ? '...' : ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${module.filiereNom}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">Semestre ${module.semestre}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${module.professeurNom || 'Non assigné'}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        <span class="font-medium">C:</span> ${module.heuresCours}h
                                        <span class="font-medium ml-2">TD:</span> ${module.heuresTD}h
                                        <span class="font-medium ml-2">TP:</span> ${module.heuresTP}h
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="flex space-x-2">
                                        <button onclick="showElementsModal(${module.id}, '${module.nom}')" class="text-blue-600 hover:text-blue-900">Éléments</button>
                                        <button onclick="editModule(${module.id})" class="text-green-600 hover:text-green-900">Modifier</button>
                                        <button onclick="showDeleteModal(${module.id})" class="text-red-600 hover:text-red-900">Supprimer</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Aucun module trouvé</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des modules:', error);
                document.getElementById('modules-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-500">Erreur lors du chargement des modules</td>
                    </tr>
                `;
            }
        }
        
        // Filtrer les modules par filière
        function filterModulesByFiliere() {
            currentFiliereFilter = document.getElementById('filiere-select').value;
            loadModules();
        }
        
        // Filtrer les modules par semestre
        function filterModulesBySemestre() {
            currentSemestreFilter = document.getElementById('semestre-select').value;
            loadModules();
        }
        
        // Afficher le formulaire d'ajout de module
        function showAddModuleForm() {
            document.getElementById('form-title').textContent = 'Ajouter un module';
            document.getElementById('module-id').value = '';
            document.getElementById('module-nom').value = '';
            document.getElementById('module-description').value = '';
            document.getElementById('module-filiere').value = currentFiliereFilter || '';
            document.getElementById('module-semestre').value = currentSemestreFilter || '';
            document.getElementById('module-professeur').value = '';
            document.getElementById('module-heures-cours').value = '';
            document.getElementById('module-heures-td').value = '';
            document.getElementById('module-heures-tp').value = '';
            document.getElementById('module-form').classList.remove('hidden');
        }
        
        // Cacher le formulaire de module
        function hideModuleForm() {
            document.getElementById('module-form').classList.add('hidden');
        }
        
        // Éditer un module existant
        async function editModule(id) {
            try {
                const module = await apiGet(`http://localhost:8080/api/modules/${id}`);
                
                document.getElementById('form-title').textContent = 'Modifier un module';
                document.getElementById('module-id').value = module.id;
                document.getElementById('module-nom').value = module.nom;
                document.getElementById('module-description').value = module.description;
                document.getElementById('module-filiere').value = module.filiereId;
                document.getElementById('module-semestre').value = module.semestre;
                document.getElementById('module-professeur').value = module.professeurId || '';
                document.getElementById('module-heures-cours').value = module.heuresCours;
                document.getElementById('module-heures-td').value = module.heuresTD;
                document.getElementById('module-heures-tp').value = module.heuresTP;
                
                document.getElementById('module-form').classList.remove('hidden');
                
                // Faire défiler jusqu'au formulaire
                document.getElementById('module-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Erreur lors du chargement du module:', error);
                showNotification('Erreur lors du chargement du module', 'error');
            }
        }
        
        // Soumission du formulaire de module
        async function submitModuleForm(event) {
            event.preventDefault();
            
            const id = document.getElementById('module-id').value;
            const nom = document.getElementById('module-nom').value;
            const description = document.getElementById('module-description').value;
            const filiereId = document.getElementById('module-filiere').value;
            const semestre = document.getElementById('module-semestre').value;
            const professeurId = document.getElementById('module-professeur').value || null;
            const heuresCours = document.getElementById('module-heures-cours').value;
            const heuresTD = document.getElementById('module-heures-td').value;
            const heuresTP = document.getElementById('module-heures-tp').value;
            
            const moduleData = {
                nom,
                description,
                filiereId: parseInt(filiereId),
                semestre: parseInt(semestre),
                professeurId: professeurId ? parseInt(professeurId) : null,
                heuresCours: parseInt(heuresCours),
                heuresTD: parseInt(heuresTD),
                heuresTP: parseInt(heuresTP)
            };
            
            try {
                let result;
                
                if (id) {
                    // Mise à jour d'un module existant
                    moduleData.id = parseInt(id);
                    result = await apiPut(`http://localhost:8080/api/admin/modules/${id}`, moduleData);
                    showNotification('Module mis à jour avec succès');
                } else {
                    // Création d'un nouveau module
                    result = await apiPost('http://localhost:8080/api/admin/modules', moduleData);
                    showNotification('Module créé avec succès');
                }
                
                // Cacher le formulaire et rafraîchir la liste
                hideModuleForm();
                loadModules();
            } catch (error) {
                console.error('Erreur lors de la sauvegarde du module:', error);
                showNotification('Erreur lors de la sauvegarde du module', 'error');
            }
        }
        
        // Afficher la modal de confirmation de suppression
        function showDeleteModal(id) {
            currentModuleId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
            
            // Configurer le bouton de confirmation
            document.getElementById('confirm-delete-btn').onclick = function() {
                deleteModule(currentModuleId);
            };
        }
        
        // Cacher la modal de confirmation
        function hideDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            currentModuleId = null;
        }
        
        // Supprimer un module
        async function deleteModule(id) {
            try {
                const result = await apiDelete(`http://localhost:8080/api/admin/modules/${id}`);
                hideDeleteModal();
                showNotification('Module supprimé avec succès');
                loadModules();
            } catch (error) {
                console.error('Erreur lors de la suppression du module:', error);
                hideDeleteModal();
                
                // Vérifier s'il y a un message d'erreur spécifique
                if (error.message && error.message.includes('éléments')) {
                    showNotification('Impossible de supprimer ce module car des éléments y sont associés', 'error');
                } else {
                    showNotification('Erreur lors de la suppression du module', 'error');
                }
            }
        }
        
        // Afficher la modal de gestion des éléments
        async function showElementsModal(moduleId, moduleName) {
            currentModuleId = moduleId;
            document.getElementById('elements-modal-title').textContent = `Éléments du module "${moduleName}"`;
            document.getElementById('element-module-id').value = moduleId;
            document.getElementById('element-id').value = '';
            
            // Réinitialiser le formulaire d'élément
            document.getElementById('element-form-action').textContent = 'Ajouter';
            document.getElementById('element-nom').value = '';
            document.getElementById('element-description').value = '';
            document.getElementById('element-heures-cours').value = '';
            document.getElementById('element-heures-td').value = '';
            document.getElementById('element-heures-tp').value = '';
            document.getElementById('element-professeur').value = '';
            
            // Afficher la modal
            document.getElementById('elements-modal').classList.remove('hidden');
            
            // Charger les éléments du module
            loadElements(moduleId);
        }
        
        // Cacher la modal de gestion des éléments
        function hideElementsModal() {
            document.getElementById('elements-modal').classList.add('hidden');
            currentModuleId = null;
        }
        
        // Charger les éléments d'un module
        async function loadElements(moduleId) {
            try {
                const elements = await apiGet(`http://localhost:8080/api/modules/${moduleId}/elements`);
                const elementsListDiv = document.getElementById('elements-list');
                
                if (elements && elements.length > 0) {
                    elementsListDiv.innerHTML = `
                        <div class="divide-y divide-gray-200">
                            ${elements.map(element => `
                                <div class="py-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium text-gray-900">${element.nom}</h4>
                                            <p class="text-sm text-gray-600 mt-1">${element.description}</p>
                                            <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                                <div>
                                                    <span class="font-medium">Cours:</span> ${element.heuresCours}h
                                                </div>
                                                <div>
                                                    <span class="font-medium">TD:</span> ${element.heuresTD}h
                                                </div>
                                                <div>
                                                    <span class="font-medium">TP:</span> ${element.heuresTP}h
                                                </div>
                                                <div>
                                                    <span class="font-medium">Professeur:</span> ${element.professeurNom || 'Non assigné'}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editElement(${element.id})" class="text-blue-600 hover:text-blue-900 text-sm">Modifier</button>
                                            <button onclick="deleteElement(${element.id})" class="text-red-600 hover:text-red-900 text-sm">Supprimer</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    elementsListDiv.innerHTML = `
                        <p class="text-gray-500 text-center py-4">Aucun élément associé à ce module</p>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des éléments:', error);
                document.getElementById('elements-list').innerHTML = `
                    <p class="text-red-500 text-center py-4">Erreur lors du chargement des éléments</p>
                `;
            }
        }
        
        // Éditer un élément
        async function editElement(elementId) {
            try {
                const element = await apiGet(`http://localhost:8080/api/elements/${elementId}`);
                
                // Remplir le formulaire avec les données de l'élément
                document.getElementById('element-id').value = element.id;
                document.getElementById('element-nom').value = element.nom;
                document.getElementById('element-description').value = element.description;
                document.getElementById('element-heures-cours').value = element.heuresCours;
                document.getElementById('element-heures-td').value = element.heuresTD;
                document.getElementById('element-heures-tp').value = element.heuresTP;
                document.getElementById('element-professeur').value = element.professeurId || '';
                
                // Changer le texte du bouton
                document.getElementById('element-form-action').textContent = 'Modifier';
                
                // Faire défiler jusqu'au formulaire
                document.getElementById('element-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Erreur lors du chargement de l\'élément:', error);
                showNotification('Erreur lors du chargement de l\'élément', 'error');
            }
        }
        
        // Soumettre le formulaire d'élément
        async function submitElementForm(event) {
            event.preventDefault();
            
            const elementId = document.getElementById('element-id').value;
            const moduleId = document.getElementById('element-module-id').value;
            const nom = document.getElementById('element-nom').value;
            const description = document.getElementById('element-description').value;
            const heuresCours = document.getElementById('element-heures-cours').value;
            const heuresTD = document.getElementById('element-heures-td').value;
            const heuresTP = document.getElementById('element-heures-tp').value;
            const professeurId = document.getElementById('element-professeur').value || null;
            
            const elementData = {
                nom,
                description,
                moduleId: parseInt(moduleId),
                heuresCours: parseInt(heuresCours),
                heuresTD: parseInt(heuresTD),
                heuresTP: parseInt(heuresTP),
                professeurId: professeurId ? parseInt(professeurId) : null
            };
            
            try {
                let result;
                
                if (elementId) {
                    // Mise à jour d'un élément existant
                    elementData.id = parseInt(elementId);
                    result = await apiPut(`http://localhost:8080/api/admin/elements/${elementId}`, elementData);
                    showNotification('Élément mis à jour avec succès');
                } else {
                    // Création d'un nouvel élément
                    result = await apiPost('http://localhost:8080/api/admin/elements', elementData);
                    showNotification('Élément créé avec succès');
                }
                
                // Réinitialiser le formulaire
                document.getElementById('element-id').value = '';
                document.getElementById('element-nom').value = '';
                document.getElementById('element-description').value = '';
                document.getElementById('element-heures-cours').value = '';
                document.getElementById('element-heures-td').value = '';
                document.getElementById('element-heures-tp').value = '';
                document.getElementById('element-professeur').value = '';
                document.getElementById('element-form-action').textContent = 'Ajouter';
                
                // Rafraîchir la liste des éléments
                loadElements(moduleId);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde de l\'élément:', error);
                showNotification('Erreur lors de la sauvegarde de l\'élément', 'error');
            }
        }
        
        // Supprimer un élément
        async function deleteElement(elementId) {
            try {
                const result = await apiDelete(`http://localhost:8080/api/admin/elements/${elementId}`);
                showNotification('Élément supprimé avec succès');
                
                // Rafraîchir la liste des éléments
                loadElements(currentModuleId);
            } catch (error) {
                console.error('Erreur lors de la suppression de l\'élément:', error);
                showNotification('Erreur lors de la suppression de l\'élément', 'error');
            }
        }
    </script>
</body>
</html>