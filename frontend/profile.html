<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Système Universitaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/custom.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">Système Universitaire</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info">Chargement...</span>
                <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded">
                    Déconnexion
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation dynamique - sera remplie par JavaScript selon le rôle -->
    <nav class="bg-white shadow" id="navigation">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-wrap space-x-1 md:space-x-4" id="nav-links">
                <!-- Les liens seront ajoutés dynamiquement -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-blue-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold">Mon Profil Utilisateur</h2>
                </div>
                
                <!-- Informations utilisateur -->
                <div class="p-6" id="user-profile">
                    <div class="animate-pulse bg-gray-200 h-40 rounded"></div>
                </div>
                
                <!-- Formulaire de changement de mot de passe -->
                <div class="p-6 border-t border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-semibold mb-4">Changer mon mot de passe</h3>
                    <form id="password-form" onsubmit="changePassword(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe actuel</label>
                                <input type="password" id="current-password" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div></div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
                                <input type="password" id="new-password" required minlength="4"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmer le mot de passe</label>
                                <input type="password" id="confirm-password" required minlength="4"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div id="password-error" class="text-red-600 text-sm mb-4 hidden"></div>
                        <div class="flex justify-end">
                            <button type="submit" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                Changer le mot de passe
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur est authentifié
            const user = checkAuth();
            if (!user) return;
            
            // Afficher les informations de l'utilisateur dans l'en-tête
            document.getElementById('user-info').textContent = `${user.prenom} ${user.nom}`;
            
            // Configurer la navigation selon le rôle
            setupNavigation(user.role);
            
            // Charger le profil utilisateur
            loadUserProfile();
        });
        
        // Configurer la navigation selon le rôle
        function setupNavigation(role) {
            const navLinks = document.getElementById('nav-links');
            
            // Déterminer les liens de navigation selon le rôle
            let links = [];
            
            switch (role) {
                case 'STUDENT':
                    links = [
                        { href: 'student/dashboard.html', text: 'Tableau de bord' },
                        { href: 'student/card-request.html', text: 'Carte étudiant' },
                        { href: 'profile.html', text: 'Mon profil', active: true }
                    ];
                    break;
                    
                case 'PROFESSOR':
                    links = [
                        { href: 'professor/dashboard.html', text: 'Tableau de bord' },
                        { href: 'professor/modules.html', text: 'Mes modules' },
                        { href: 'profile.html', text: 'Mon profil', active: true }
                    ];
                    break;
                    
                case 'ADMIN':
                    links = [
                        { href: 'admin/dashboard.html', text: 'Tableau de bord' },
                        { href: 'admin/filieres.html', text: 'Filières' },
                        { href: 'admin/modules.html', text: 'Modules' },
                        { href: 'admin/professors.html', text: 'Professeurs' },
                        { href: 'admin/students.html', text: 'Étudiants' },
                        { href: 'admin/card-requests.html', text: 'Demandes de cartes' },
                        { href: 'profile.html', text: 'Mon profil', active: true }
                    ];
                    break;
                    
                default:
                    // En cas de rôle inconnu
                    links = [
                        { href: 'login.html', text: 'Connexion' }
                    ];
            }
            
            // Générer les liens HTML
            navLinks.innerHTML = links.map(link => `
                <a href="${link.href}" 
                   class="${link.active 
                       ? 'bg-blue-100 text-blue-700 px-3 py-2 rounded font-medium mb-2' 
                       : 'text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium mb-2'}">
                    ${link.text}
                </a>
            `).join('');
        }
        
        // Charger le profil utilisateur
        async function loadUserProfile() {
            try {
                const profile = await apiGet('http://localhost:8080/api/auth/profile');
                const profileDiv = document.getElementById('user-profile');
                
                if (profile) {
                    // Déterminer les informations spécifiques au rôle
                    let roleSpecificInfo = '';
                    
                    switch (profile.role) {
                        case 'STUDENT':
                            // Formater l'année
                            let annee = '';
                            if (profile.annee === 'PREMIERE_ANNEE') annee = '1ère année';
                            else if (profile.annee === 'DEUXIEME_ANNEE') annee = '2ème année';
                            
                            // Formatter le statut
                            let statut = '';
                            if (profile.statut === 'ACTIF') statut = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Actif</span>';
                            else if (profile.statut === 'SUSPENDU') statut = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">Suspendu</span>';
                            else if (profile.statut === 'ARRETE') statut = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs">Arrêté</span>';
                            
                            roleSpecificInfo = `
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Numéro Apogée</p>
                                        <p class="font-medium">${profile.nApogee || 'Non disponible'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Filière</p>
                                        <p class="font-medium" id="filiere-name">Chargement...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Année</p>
                                        <p class="font-medium">${annee || 'Non disponible'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Statut</p>
                                        <p class="font-medium">${statut || 'Non disponible'}</p>
                                    </div>
                                </div>
                            `;
                            
                            // Charger le nom de la filière si l'ID est disponible
                            if (profile.filiereId) {
                                loadFiliereName(profile.filiereId);
                            }
                            break;
                            
                        case 'PROFESSOR':
                            // Si des informations spécifiques sont nécessaires pour les professeurs
                            break;
                            
                        case 'ADMIN':
                            // Si des informations spécifiques sont nécessaires pour les administrateurs
                            break;
                    }
                    
                    // Afficher le profil
                    profileDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Nom</p>
                                <p class="font-medium">${profile.nom || 'Non disponible'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Prénom</p>
                                <p class="font-medium">${profile.prenom || 'Non disponible'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="font-medium">${profile.email || 'Non disponible'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Date de naissance</p>
                                <p class="font-medium">${formatDate(profile.dateNaissance).split(' ')[0] || 'Non disponible'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Rôle</p>
                                <p class="font-medium">${getRoleName(profile.role) || 'Non disponible'}</p>
                            </div>
                        </div>
                        ${roleSpecificInfo}
                    `;
                } else {
                    profileDiv.innerHTML = `
                        <p class="text-red-600">Erreur lors du chargement du profil</p>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
                document.getElementById('user-profile').innerHTML = `
                    <p class="text-red-600">Erreur lors du chargement du profil</p>
                `;
            }
        }
        
        // Charger le nom de la filière pour les étudiants
        async function loadFiliereName(filiereId) {
            try {
                const data = await apiGet(`http://localhost:8080/api/filieres/${filiereId}`);
                if (data) {
                    document.getElementById('filiere-name').textContent = data.nom;
                }
            } catch (error) {
                document.getElementById('filiere-name').textContent = 'Non disponible';
            }
        }
        
        // Obtenir le nom du rôle en français
        function getRoleName(role) {
            switch (role) {
                case 'STUDENT':
                    return 'Étudiant';
                case 'PROFESSOR':
                    return 'Professeur';
                case 'ADMIN':
                    return 'Administrateur';
                default:
                    return role;
            }
        }
        
        // Changer le mot de passe
        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            
            // Vérifier que les mots de passe correspondent
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const result = await apiPost('http://localhost:8080/api/auth/change-password', {}, {
                    oldPassword: currentPassword,
                    newPassword: newPassword
                });
                
                // Réinitialiser le formulaire
                document.getElementById('password-form').reset();
                errorDiv.classList.add('hidden');
                
                showNotification('Mot de passe modifié avec succès');
            } catch (error) {
                console.error('Erreur lors du changement de mot de passe:', error);
                errorDiv.textContent = 'Erreur: Ancien mot de passe incorrect ou problème lors de la modification';
                errorDiv.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>