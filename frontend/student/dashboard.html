<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Étudiant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/custom.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">Système Universitaire</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info">Chargement...</span>
                <div class="relative group">
                    <button class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded flex items-center">
                        <span>Menu</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden group-hover:block z-10">
                        <div class="py-1">
                            <a href="../profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mon profil</a>
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Déconnexion</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="container mx-auto px-4 py-3">
            <div class="flex space-x-4">
                <a href="dashboard.html" class="bg-blue-100 text-blue-700 px-3 py-2 rounded font-medium">Tableau de bord</a>
                <a href="card-request.html" class="text-gray-700 hover:bg-gray-100 px-3 py-2 rounded font-medium">Ma carte</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Informations de l'étudiant -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Carte d'informations personnelles -->
            <div class="bg-white rounded-lg shadow p-6 col-span-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Mes informations</h2>
                <div id="student-info" class="space-y-3">
                    <div class="animate-pulse bg-gray-200 h-6 rounded"></div>
                    <div class="animate-pulse bg-gray-200 h-6 rounded"></div>
                </div>
            </div>

            <!-- Carte étudiant -->
            <div class="bg-white rounded-lg shadow p-6 col-span-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Ma carte étudiant</h2>
                <div id="card-status" class="animate-pulse bg-gray-200 h-20 rounded"></div>
                <div id="card-action" class="mt-4"></div>
            </div>
            
            <!-- Notifications -->
            <div class="bg-white rounded-lg shadow p-6 col-span-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Notifications</h2>
                <div id="notifications" class="space-y-3">
                    <div class="animate-pulse bg-gray-200 h-16 rounded"></div>
                    <div class="animate-pulse bg-gray-200 h-16 rounded"></div>
                </div>
            </div>
        </div>
        
        <!-- Modules et éléments -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Mes modules</h2>
            <div id="student-modules" class="animate-pulse bg-gray-200 h-40 rounded"></div>
        </div>
    </main>

    <script src="../js/auth.js"></script>
    <script src="../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur est authentifié
            const user = checkAuth();
            if (!user) return;
            
            // Vérifier si l'utilisateur est bien un étudiant
            if (user.role !== 'STUDENT') {
                logout();
                return;
            }
            
            // Afficher les informations de l'utilisateur
            document.getElementById('user-info').textContent = `${user.prenom} ${user.nom}`;
            
            // Charger les informations de l'étudiant
            loadStudentInfo();
            
            // Charger le statut de la carte
            loadCardStatus();
            
            // Charger les modules de l'étudiant (basé sur sa filière)
            loadStudentModules();
            
            // Charger les notifications
            loadNotifications();
        });

        // Charger les informations de l'étudiant
        async function loadStudentInfo() {
            try {
                const data = await apiGet('http://localhost:8080/api/auth/profile');
                
                if (data) {
                    const studentInfoDiv = document.getElementById('student-info');
                    studentInfoDiv.innerHTML = `
                        <div class="mb-2">
                            <span class="font-semibold">Nom complet:</span> 
                            ${data.prenom} ${data.nom}
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Numéro Apogée:</span> 
                            ${data.nApogee || 'Non disponible'}
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Email:</span> 
                            ${data.email}
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Filière:</span> 
                            <span id="filiere-name">Chargement...</span>
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Année:</span> 
                            ${data.annee === 'PREMIERE_ANNEE' ? '1ère année' : '2ème année'}
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Date de naissance:</span> 
                            ${formatDate(data.dateNaissance).split(' ')[0]}
                        </div>
                        <div class="mb-2">
                            <span class="font-semibold">Statut:</span> 
                            ${getStatusLabel(data.statut)}
                        </div>
                    `;
                    
                    // Charger le nom de la filière si l'ID est disponible
                    if (data.filiereId) {
                        loadFiliereName(data.filiereId);
                        // Charger les modules de cette filière
                        loadModulesByFiliere(data.filiereId, data.annee);
                    } else {
                        document.getElementById('filiere-name').textContent = 'Non affectée';
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des informations de l\'étudiant:', error);
                showNotification('Erreur lors du chargement des informations', 'error');
            }
        }

        // Charger le nom de la filière
        async function loadFiliereName(filiereId) {
            try {
                const data = await apiGet(`http://localhost:8080/api/filieres/${filiereId}`);
                if (data) {
                    document.getElementById('filiere-name').textContent = data.nom;
                }
            } catch (error) {
                document.getElementById('filiere-name').textContent = 'Non disponible';
            }
        }

        // Charger les modules de la filière de l'étudiant
        async function loadModulesByFiliere(filiereId, annee) {
            try {
                // Convertir l'année en semestres
                let semestres = [];
                if (annee === 'PREMIERE_ANNEE') {
                    semestres = [1, 2];
                } else if (annee === 'DEUXIEME_ANNEE') {
                    semestres = [3, 4];
                }
                
                // Récupérer les modules pour chaque semestre
                const modulesPromises = semestres.map(semestre => 
                    apiGet(`http://localhost:8080/api/filieres/${filiereId}/semestres/${semestre}/modules`)
                );
                
                const modulesArrays = await Promise.all(modulesPromises);
                
                // Combiner tous les modules et les organiser par semestre
                const modulesBySemester = {};
                semestres.forEach((semestre, index) => {
                    modulesBySemester[semestre] = modulesArrays[index] || [];
                });
                
                const modulesDiv = document.getElementById('student-modules');
                
                if (Object.values(modulesBySemester).some(modules => modules.length > 0)) {
                    let html = `<div class="space-y-6">`;
                    
                    // Pour chaque semestre
                    for (const semestre of semestres) {
                        const modules = modulesBySemester[semestre];
                        if (modules.length === 0) continue;
                        
                        html += `
                            <div>
                                <h3 class="text-lg font-medium text-blue-700 mb-3">Semestre ${semestre}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${modules.map(module => `
                                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <h4 class="font-semibold text-gray-900">${module.nom}</h4>
                                            <p class="text-gray-600 text-sm mb-3">${module.description.substring(0, 100)}${module.description.length > 100 ? '...' : ''}</p>
                                            <div class="text-xs text-gray-500 grid grid-cols-3 gap-1">
                                                <div>Cours: ${module.heuresCours}h</div>
                                                <div>TD: ${module.heuresTD}h</div>
                                                <div>TP: ${module.heuresTP}h</div>
                                            </div>
                                            <div class="mt-2 text-sm">
                                                <span class="text-gray-700">Prof: ${module.professeurNom || 'Non assigné'}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    modulesDiv.innerHTML = html;
                } else {
                    modulesDiv.innerHTML = `<p class="text-gray-500">Aucun module disponible pour votre filière et année.</p>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des modules:', error);
                document.getElementById('student-modules').innerHTML = `<p class="text-red-600">Erreur lors du chargement des modules</p>`;
            }
        }

        // Charger le statut de la carte étudiant
        async function loadCardStatus() {
            try {
                const requests = await apiGet('http://localhost:8080/api/student/card-requests');
                const cardStatusDiv = document.getElementById('card-status');
                const cardActionDiv = document.getElementById('card-action');
                
                if (!requests || requests.length === 0) {
                    // Aucune demande de carte
                    cardStatusDiv.innerHTML = `
                        <p class="text-yellow-600">Vous n'avez pas encore demandé votre carte étudiant.</p>
                    `;
                    cardActionDiv.innerHTML = `
                        <button onclick="requestCard()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                            Demander la carte
                        </button>
                    `;
                } else {
                    // Dernière demande (la plus récente)
                    const latestRequest = requests[0];
                    
                    // Afficher le statut
                    switch (latestRequest.status) {
                        case 'PENDING':
                            cardStatusDiv.innerHTML = `
                                <div class="p-4 border-l-4 border-yellow-400 bg-yellow-50">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-yellow-700">
                                                Votre demande de carte est en cours de traitement.
                                            </p>
                                            <p class="text-xs text-yellow-500 mt-1">
                                                Demande soumise le ${formatDate(latestRequest.requestDate)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            cardActionDiv.innerHTML = '';
                            break;
                            
                        case 'APPROVED':
                            cardStatusDiv.innerHTML = `
                                <div class="p-4 border-l-4 border-green-400 bg-green-50">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-green-700">
                                                Votre demande de carte a été approuvée.
                                            </p>
                                            <p class="text-xs text-green-500 mt-1">
                                                Approuvée le ${formatDate(latestRequest.processedDate)}
                                            </p>
                                            <p class="text-xs text-green-500 mt-1">
                                                Veuillez récupérer votre carte au bureau des cartes étudiantes.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            cardActionDiv.innerHTML = `
                                <button onclick="confirmCardReception(${latestRequest.id})" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded">
                                    Confirmer réception de la carte
                                </button>
                            `;
                            break;
                            
                        case 'REJECTED':
                            cardStatusDiv.innerHTML = `
                                <div class="p-4 border-l-4 border-red-400 bg-red-50">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-red-700">
                                                Votre demande de carte a été rejetée.
                                            </p>
                                            <p class="text-xs text-red-500 mt-1">
                                                Rejetée le ${formatDate(latestRequest.processedDate)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            cardActionDiv.innerHTML = `
                                <button onclick="requestCard()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                    Faire une nouvelle demande
                                </button>
                            `;
                            break;
                            
                        case 'RECEIVED':
                            cardStatusDiv.innerHTML = `
                                <div class="p-4 border-l-4 border-blue-400 bg-blue-50">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-blue-700">
                                                Vous avez récupéré votre carte étudiant.
                                            </p>
                                            <p class="text-xs text-blue-500 mt-1">
                                                Carte récupérée le ${formatDate(latestRequest.receivedDate)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            cardActionDiv.innerHTML = '';
                            break;
                            
                        default:
                            cardStatusDiv.innerHTML = `<p>Statut inconnu</p>`;
                            cardActionDiv.innerHTML = '';
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement du statut de la carte:', error);
                document.getElementById('card-status').innerHTML = `
                    <p class="text-red-600">Erreur lors du chargement du statut de la carte</p>
                `;
            }
        }

        // Charger les notifications
        async function loadNotifications() {
            try {
                // Simulation des notifications (à remplacer par un appel API réel)
                const notifications = [
                    {
                        id: 1,
                        message: "Votre demande de carte étudiant a été approuvée.",
                        date: new Date(),
                        read: false,
                        type: "CARD_APPROVED"
                    },
                    {
                        id: 2,
                        message: "Bienvenue sur le système de gestion universitaire.",
                        date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 jours avant
                        read: true,
                        type: "SYSTEM"
                    }
                ];
                
                const notificationsDiv = document.getElementById('notifications');
                
                if (notifications && notifications.length > 0) {
                    notificationsDiv.innerHTML = notifications.map(notification => {
                        const isUnread = !notification.read;
                        const bgColor = isUnread ? 'bg-blue-50' : 'bg-white';
                        const dotColor = isUnread ? '<span class="h-2 w-2 bg-blue-600 rounded-full"></span>' : '';
                        
                        let icon = '';
                        switch (notification.type) {
                            case 'CARD_REQUEST':
                            case 'CARD_APPROVED':
                            case 'CARD_REJECTED':
                            case 'CARD_RECEIVED':
                                icon = '<svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>';
                                break;
                            default:
                                icon = '<svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>';
                        }
                        
                        return `
                            <div class="flex items-start p-3 ${bgColor} rounded-lg border ${isUnread ? 'border-blue-200' : 'border-gray-200'}">
                                <div class="flex-shrink-0 mr-2">
                                    ${icon}
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-800">${notification.message}</p>
                                    <p class="text-xs text-gray-500 mt-1">${formatDate(notification.date)}</p>
                                </div>
                                <div class="ml-2">
                                    ${dotColor}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    notificationsDiv.innerHTML = `<p class="text-gray-500">Aucune notification récente.</p>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des notifications:', error);
                document.getElementById('notifications').innerHTML = `
                    <p class="text-red-600">Erreur lors du chargement des notifications</p>
                `;
            }
        }

        // Demander une carte
        async function requestCard() {
            try {
                const result = await apiPost('http://localhost:8080/api/student/card-requests', {});
                
                if (result) {
                    showNotification('Demande de carte envoyée avec succès');
                    // Recharger le statut
                    loadCardStatus();
                }
            } catch (error) {
                console.error('Erreur lors de la demande de carte:', error);
                showNotification('Erreur lors de la demande de carte', 'error');
            }
        }

        // Confirmer la réception de la carte
        async function confirmCardReception(requestId) {
            try {
                const result = await apiPut(`http://localhost:8080/api/student/card-requests/${requestId}/confirm-reception`, {});
                
                if (result) {
                    showNotification('Réception de la carte confirmée avec succès');
                    // Recharger le statut
                    loadCardStatus();
                }
            } catch (error) {
                console.error('Erreur lors de la confirmation de réception:', error);
                showNotification('Erreur lors de la confirmation de réception', 'error');
            }
        }

        // Obtenir le libellé du statut étudiant
        function getStatusLabel(status) {
            switch (status) {
                case 'ACTIF':
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded">Actif</span>';
                case 'SUSPENDU':
                    return '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">Suspendu</span>';
                case 'ARRETE':
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded">Arrêté</span>';
                default:
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded">Non défini</span>';
            }
        }

        // Charger les modules pour l'étudiant (pourrait être implanté plus tard par un endpoint dédié)
        async function loadStudentModules() {
            // Pour l'instant, cette fonction est un placeholder.
            // Elle serait appelée par loadStudentInfo via loadModulesByFiliere
        }
    </script>
</body>
</html>